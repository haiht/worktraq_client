var arr_color = new Array();
arr_color[0] = '<option style="color:#F0F8FF" value="#F0F8FF">AliceBlue</option>';
arr_color[1] = '<option style="color:#FAEBD7" value="#FAEBD7">AntiqueWhite</option>';
arr_color[2] = '<option style="color:#00FFFF" value="#00FFFF">Aqua</option>';
arr_color[3] = '<option style="color:#7FFFD4" value="#7FFFD4">Aquamarine</option>';
arr_color[4] = '<option style="color:#F0FFFF" value="#F0FFFF">Azure</option>';
arr_color[5] = '<option style="color:#F5F5DC" value="#F5F5DC">Beige</option>';
arr_color[6] = '<option style="color:#FFE4C4" value="#FFE4C4">Bisque</option>';
arr_color[7] = '<option style="color:#000000" value="#000000" selected="selected">Black</option>';
arr_color[8] = '<option style="color:#FFEBCD" value="#FFEBCD">BlanchedAlmond</option>';
arr_color[9] = '<option style="color:#0000FF" value="#0000FF">Blue</option>';
arr_color[10] = '<option style="color:#8A2BE2" value="#8A2BE2">BlueViolet</option>';
arr_color[11] = '<option style="color:#A52A2A" value="#A52A2A">Brown</option>';
arr_color[12] = '<option style="color:#DEB887" value="#DEB887">BurlyWood</option>';
arr_color[13] = '<option style="color:#5F9EA0" value="#5F9EA0">CadetBlue</option>';
arr_color[14] = '<option style="color:#7FFF00" value="#7FFF00">Chartreuse</option>';
arr_color[15] = '<option style="color:#D2691E" value="#D2691E">Chocolate</option>';
arr_color[16] = '<option style="color:#FF7F50" value="#FF7F50">Coral</option>';
arr_color[17] = '<option style="color:#6495ED" value="#6495ED">CornflowerBlue</option>';
arr_color[18] = '<option style="color:#FFF8DC" value="#FFF8DC">Cornsilk</option>';
arr_color[19] = '<option style="color:#DC143C" value="#DC143C">Crimson</option>';
arr_color[20] = '<option style="color:#00FFFF" value="#00FFFF">Cyan</option>';
arr_color[21] = '<option style="color:#00008B" value="#00008B">DarkBlue</option>';
arr_color[22] = '<option style="color:#008B8B" value="#008B8B">DarkCyan</option>';
arr_color[23] = '<option style="color:#B8860B" value="#B8860B">DarkGoldenRod</option>';
arr_color[24] = '<option style="color:#A9A9A9" value="#A9A9A9">DarkGray</option>';
arr_color[25] = '<option style="color:#A9A9A9" value="#A9A9A9">DarkGrey</option>';
arr_color[26] = '<option style="color:#006400" value="#006400">DarkGreen</option>';
arr_color[27] = '<option style="color:#BDB76B" value="#BDB76B">DarkKhaki</option>';
arr_color[28] = '<option style="color:#8B008B" value="#8B008B">DarkMagenta</option>';
arr_color[29] = '<option style="color:#556B2F" value="#556B2F">DarkOliveGreen</option>';
arr_color[30] = '<option style="color:#FF8C00" value="#FF8C00">Darkorange</option>';
arr_color[31] = '<option style="color:#9932CC" value="#9932CC">DarkOrchid</option>';
arr_color[32] = '<option style="color:#8B0000" value="#8B0000">DarkRed</option>';
arr_color[33] = '<option style="color:#E9967A" value="#E9967A">DarkSalmon</option>';
arr_color[34] = '<option style="color:#8FBC8F" value="#8FBC8F">DarkSeaGreen</option>';
arr_color[35] = '<option style="color:#483D8B" value="#483D8B">DarkSlateBlue</option>';
arr_color[36] = '<option style="color:#2F4F4F" value="#2F4F4F">DarkSlateGray</option>';
arr_color[37] = '<option style="color:#2F4F4F" value="#2F4F4F">DarkSlateGrey</option>';
arr_color[38] = '<option style="color:#00CED1" value="#00CED1">DarkTurquoise</option>';
arr_color[39] = '<option style="color:#9400D3" value="#9400D3">DarkViolet</option>';
arr_color[40] = '<option style="color:#FF1493" value="#FF1493">DeepPink</option>';
arr_color[41] = '<option style="color:#00BFFF" value="#00BFFF">DeepSkyBlue</option>';
arr_color[42] = '<option style="color:#696969" value="#696969">DimGray</option>';
arr_color[43] = '<option style="color:#696969" value="#696969">DimGrey</option>';
arr_color[44] = '<option style="color:#1E90FF" value="#1E90FF">DodgerBlue</option>';
arr_color[45] = '<option style="color:#B22222" value="#B22222">FireBrick</option>';
arr_color[46] = '<option style="color:#FFFAF0" value="#FFFAF0">FloralWhite</option>';
arr_color[47] = '<option style="color:#228B22" value="#228B22">ForestGreen</option>';
arr_color[48] = '<option style="color:#FF00FF" value="#FF00FF">Fuchsia</option>';
arr_color[49] = '<option style="color:#DCDCDC" value="#DCDCDC">Gainsboro</option>';
arr_color[50] = '<option style="color:#F8F8FF" value="#F8F8FF">GhostWhite</option>';
arr_color[51] = '<option style="color:#FFD700" value="#FFD700">Gold</option>';
arr_color[52] = '<option style="color:#DAA520" value="#DAA520">GoldenRod</option>';
arr_color[53] = '<option style="color:#808080" value="#808080">Gray</option>';
arr_color[54] = '<option style="color:#808080" value="#808080">Grey</option>';
arr_color[55] = '<option style="color:#008000" value="#008000">Green</option>';
arr_color[56] = '<option style="color:#ADFF2F" value="#ADFF2F">GreenYellow</option>';
arr_color[57] = '<option style="color:#F0FFF0" value="#F0FFF0">HoneyDew</option>';
arr_color[58] = '<option style="color:#FF69B4" value="#FF69B4">HotPink</option>';
arr_color[59] = '<option style="color:#CD5C5C" value="#CD5C5C">IndianRed</option>';
arr_color[60] = '<option style="color:#4B0082" value="#4B0082">Indigo</option>';
arr_color[61] = '<option style="color:#FFFFF0" value="#FFFFF0">Ivory</option>';
arr_color[62] = '<option style="color:#F0E68C" value="#F0E68C">Khaki</option>';
arr_color[63] = '<option style="color:#E6E6FA" value="#E6E6FA">Lavender</option>';
arr_color[64] = '<option style="color:#FFF0F5" value="#FFF0F5">LavenderBlush</option>';
arr_color[65] = '<option style="color:#7CFC00" value="#7CFC00">LawnGreen</option>';
arr_color[66] = '<option style="color:#FFFACD" value="#FFFACD">LemonChiffon</option>';
arr_color[67] = '<option style="color:#ADD8E6" value="#ADD8E6">LightBlue</option>';
arr_color[68] = '<option style="color:#F08080" value="#F08080">LightCoral</option>';
arr_color[69] = '<option style="color:#E0FFFF" value="#E0FFFF">LightCyan</option>';
arr_color[70] = '<option style="color:#FAFAD2" value="#FAFAD2">LightGoldenRodYellow</option>';
arr_color[71] = '<option style="color:#D3D3D3" value="#D3D3D3">LightGray</option>';
arr_color[72] = '<option style="color:#D3D3D3" value="#D3D3D3">LightGrey</option>';
arr_color[73] = '<option style="color:#90EE90" value="#90EE90">LightGreen</option>';
arr_color[74] = '<option style="color:#FFB6C1" value="#FFB6C1">LightPink</option>';
arr_color[75] = '<option style="color:#FFA07A" value="#FFA07A">LightSalmon</option>';
arr_color[76] = '<option style="color:#20B2AA" value="#20B2AA">LightSeaGreen</option>';
arr_color[77] = '<option style="color:#87CEFA" value="#87CEFA">LightSkyBlue</option>';
arr_color[78] = '<option style="color:#778899" value="#778899">LightSlateGray</option>';
arr_color[79] = '<option style="color:#778899" value="#778899">LightSlateGrey</option>';
arr_color[80] = '<option style="color:#B0C4DE" value="#B0C4DE">LightSteelBlue</option>';
arr_color[81] = '<option style="color:#FFFFE0" value="#FFFFE0">LightYellow</option>';
arr_color[82] = '<option style="color:#00FF00" value="#00FF00">Lime</option>';
arr_color[83] = '<option style="color:#32CD32" value="#32CD32">LimeGreen</option>';
arr_color[84] = '<option style="color:#FAF0E6" value="#FAF0E6">Linen</option>';
arr_color[85] = '<option style="color:#FF00FF" value="#FF00FF">Magenta</option>';
arr_color[86] = '<option style="color:#800000" value="#800000">Maroon</option>';
arr_color[87] = '<option style="color:#66CDAA" value="#66CDAA">MediumAquaMarine</option>';
arr_color[88] = '<option style="color:#0000CD" value="#0000CD">MediumBlue</option>';
arr_color[89] = '<option style="color:#BA55D3" value="#BA55D3">MediumOrchid</option>';
arr_color[90] = '<option style="color:#9370DB" value="#9370DB">MediumPurple</option>';
arr_color[91] = '<option style="color:#3CB371" value="#3CB371">MediumSeaGreen</option>';
arr_color[92] = '<option style="color:#7B68EE" value="#7B68EE">MediumSlateBlue</option>';
arr_color[93] = '<option style="color:#00FA9A" value="#00FA9A">MediumSpringGreen</option>';
arr_color[94] = '<option style="color:#48D1CC" value="#48D1CC">MediumTurquoise</option>';
arr_color[95] = '<option style="color:#C71585" value="#C71585">MediumVioletRed</option>';
arr_color[96] = '<option style="color:#191970" value="#191970">MidnightBlue</option>';
arr_color[97] = '<option style="color:#F5FFFA" value="#F5FFFA">MintCream</option>';
arr_color[98] = '<option style="color:#FFE4E1" value="#FFE4E1">MistyRose</option>';
arr_color[99] = '<option style="color:#FFE4B5" value="#FFE4B5">Moccasin</option>';
arr_color[100] = '<option style="color:#FFDEAD" value="#FFDEAD">NavajoWhite</option>';
arr_color[101] = '<option style="color:#000080" value="#000080">Navy</option>';
arr_color[102] = '<option style="color:#FDF5E6" value="#FDF5E6">OldLace</option>';
arr_color[103] = '<option style="color:#808000" value="#808000">Olive</option>';
arr_color[104] = '<option style="color:#6B8E23" value="#6B8E23">OliveDrab</option>';
arr_color[105] = '<option style="color:#FFA500" value="#FFA500">Orange</option>';
arr_color[106] = '<option style="color:#FF4500" value="#FF4500">OrangeRed</option>';
arr_color[107] = '<option style="color:#DA70D6" value="#DA70D6">Orchid</option>';
arr_color[108] = '<option style="color:#EEE8AA" value="#EEE8AA">PaleGoldenRod</option>';
arr_color[109] = '<option style="color:#98FB98" value="#98FB98">PaleGreen</option>';
arr_color[110] = '<option style="color:#AFEEEE" value="#AFEEEE">PaleTurquoise</option>';
arr_color[111] = '<option style="color:#DB7093" value="#DB7093">PaleVioletRed</option>';
arr_color[112] = '<option style="color:#FFEFD5" value="#FFEFD5">PapayaWhip</option>';
arr_color[113] = '<option style="color:#FFDAB9" value="#FFDAB9">PeachPuff</option>';
arr_color[114] = '<option style="color:#CD853F" value="#CD853F">Peru</option>';
arr_color[115] = '<option style="color:#FFC0CB" value="#FFC0CB">Pink</option>';
arr_color[116] = '<option style="color:#DDA0DD" value="#DDA0DD">Plum</option>';
arr_color[117] = '<option style="color:#B0E0E6" value="#B0E0E6">PowderBlue</option>';
arr_color[118] = '<option style="color:#800080" value="#800080">Purple</option>';
arr_color[119] = '<option style="color:#FF0000" value="#FF0000">Red</option>';
arr_color[120] = '<option style="color:#BC8F8F" value="#BC8F8F">RosyBrown</option>';
arr_color[121] = '<option style="color:#4169E1" value="#4169E1">RoyalBlue</option>';
arr_color[122] = '<option style="color:#8B4513" value="#8B4513">SaddleBrown</option>';
arr_color[123] = '<option style="color:#FA8072" value="#FA8072">Salmon</option>';
arr_color[124] = '<option style="color:#F4A460" value="#F4A460">SandyBrown</option>';
arr_color[125] = '<option style="color:#2E8B57" value="#2E8B57">SeaGreen</option>';
arr_color[126] = '<option style="color:#FFF5EE" value="#FFF5EE">SeaShell</option>';
arr_color[127] = '<option style="color:#A0522D" value="#A0522D">Sienna</option>';
arr_color[128] = '<option style="color:#C0C0C0" value="#C0C0C0">Silver</option>';
arr_color[129] = '<option style="color:#87CEEB" value="#87CEEB">SkyBlue</option>';
arr_color[130] = '<option style="color:#6A5ACD" value="#6A5ACD">SlateBlue</option>';
arr_color[131] = '<option style="color:#708090" value="#708090">SlateGray</option>';
arr_color[132] = '<option style="color:#708090" value="#708090">SlateGrey</option>';
arr_color[133] = '<option style="color:#FFFAFA" value="#FFFAFA">Snow</option>';
arr_color[134] = '<option style="color:#00FF7F" value="#00FF7F">SpringGreen</option>';
arr_color[135] = '<option style="color:#4682B4" value="#4682B4">SteelBlue</option>';
arr_color[136] = '<option style="color:#D2B48C" value="#D2B48C">Tan</option>';
arr_color[137] = '<option style="color:#008080" value="#008080">Teal</option>';
arr_color[138] = '<option style="color:#D8BFD8" value="#D8BFD8">Thistle</option>';
arr_color[139] = '<option style="color:#FF6347" value="#FF6347">Tomato</option>';
arr_color[140] = '<option style="color:#40E0D0" value="#40E0D0">Turquoise</option>';
arr_color[141] = '<option style="color:#EE82EE" value="#EE82EE">Violet</option>';
arr_color[142] = '<option style="color:#F5DEB3" value="#F5DEB3">Wheat</option>';
arr_color[143] = '<option style="color:#FFFFFF" value="#FFFFFF">White</option>';
arr_color[144] = '<option style="color:#F5F5F5" value="#F5F5F5">WhiteSmoke</option>';
arr_color[145] = '<option style="color:#FFFF00" value="#FFFF00">Yellow</option>';
arr_color[146] = '<option style="color:#9ACD32" value="#9ACD32">YellowGreen</option>';

var arr_font = new Array();
arr_font[0] = '<option value="Arial">Arial</option>';
arr_font[1] = '<option value="Tahoma">Tahoma</option>';
arr_font[2] = '<option value="Times New Roman">Times New Roman</option>';
arr_font[3] = '<option value="Verdana">Verdana</option>';
arr_font[4] = '<option value="Cronos_Pro">Cronos_Pro</option>';
arr_font[5] = '<option value="LasVegas-Fabulous">LasVegas-Fabulous</option>';
arr_font[6] = '<option value="Respective_Slanted">Respective_Slanted</option>';
arr_font[7] = '<option value="Shelley_Allegro_BT">Shelley_Allegro_BT</option>';
arr_font[8] = '<option value="Shelley_Volante_BT">Shelley_Volante_BT</option>';
arr_font[9] = '<option value="Shelley_Andante_BT">Shelley_Andante_BT</option>';
arr_font[10] = '<option value="Weatz_Swashes">Weatz_Swashes</option>';


/*jslint browser: true, newcap: false, white: false, onevar: false, plusplus: false, eqeqeq: false, nomen: false */
/*global window:false, $:false, imgmap:false, air:false */

/** GLOBALS SECTION ***********************************************************/

var myimgmap, props, outputmode, imgroot;

/** FUNCTION SECTION **********************************************************/

function gui_toggleMore() {
	var parent = $('#more_actions').parent().find('.toggler');
	$('#more_actions').css({
      top: $(parent).offset().top + ($(parent).outerHeight()),
      left: $(parent).offset().left
    });	
	
	$('#more_actions').slideToggle(200, function () {
		if ($(this).css('display') == 'none') {
			$(parent).addClass('toggler_off');
		}
		else {
			$(parent).removeClass('toggler_off');
		}
	});
}

function gui_colorChanged(obj) {
	myimgmap.pic_container.style.backgroundColor = obj.value;
	gui_toggleMore();
}


/**
 *	Handles mouseover on props row.
 */
function gui_row_mouseover(e) {
	if (myimgmap.is_drawing) {return;}//exit if in drawing state
	if (myimgmap.viewmode === 1) {return;}//exit if preview mode
	var obj = (myimgmap.isMSIE) ? window.event.srcElement : e.currentTarget;
	if (typeof obj.aid == 'undefined') {obj = obj.parentNode;}
	//console.log(obj.aid);
	myimgmap.highlightArea(obj.aid);
}

/**
 *	Handles mouseout on props row.
 */
function gui_row_mouseout(e) {
	if (myimgmap.is_drawing) {return;}//exit if in drawing state
	if (myimgmap.viewmode === 1) {return;}//exit if preview mode
	var obj = (myimgmap.isMSIE) ? window.event.srcElement : e.currentTarget;
	if (typeof obj.aid == 'undefined') {obj = obj.parentNode;}
	myimgmap.blurArea(obj.aid);
}

/**
 *	Handles click on props row.
 */
function gui_row_click(e) {
	if (myimgmap.viewmode === 1) {return;}//exit if preview mode
	var obj = (myimgmap.isMSIE) ? window.event.srcElement : e.currentTarget;
	//var multiple = (e.originalTarget.name == 'img_active');
	//myimgmap.log(e.originalTarget);
	if (typeof obj.aid == 'undefined') {obj = obj.parentNode;}
	//gui_row_select(obj.aid, false, multiple);
	gui_row_select(obj.aid, false, false);
	myimgmap.currentid = obj.aid;
}

/**
 *	Handles click on a property row.
 *	@author	Adam Maschek (adam.maschek(at)gmail.com)
 *	@date	2006-06-06 16:55:29
 */
function gui_row_select(id, setfocus, multiple) {
	if (myimgmap.is_drawing) {return;}//exit if in drawing state
	if (myimgmap.viewmode === 1) {return;}//exit if preview mode
	if (!document.getElementById('img_active_'+id)) {return;}
	//if (!multiple) 
	gui_cb_unselect_all();
	
	var font = props[id].getElementsByTagName('select')[2].value;
	var size = props[id].getElementsByTagName('select')[3].value;
	var color = props[id].getElementsByTagName('select')[4].value;
	var bd = props[id].getElementsByTagName('input')[5].checked?'bold':'normal';
	var it = props[id].getElementsByTagName('input')[6].checked?'italic':'normal';
	
	//myimgmap.config.label = props[id].getElementsByTagName('input')[3].value;
	myimgmap.areas[id].ahref  = myimgmap.config.areaText[id] = props[id].getElementsByTagName('input')[3].value;
	//myimgmap.config.label = props[id].getElementsByTagName('input')[3].value;
	myimgmap.config.label_style   = 'font-weight: '+bd+';font-style: '+it+';font-size: '+size+'; font-family: '+font+'; color: '+color;
	myimgmap.config.labelStyle[id] = 'font-weight: '+bd+';font-style: '+it+';font-size: '+size+'; font-family: '+font+'; color: '+color;
	//alert(
	document.getElementById('img_active_'+id).checked = 1;
	if (setfocus) {
		document.getElementById('img_active_'+id).focus();
	}
	//remove all background styles
	for (var i = 0; i < props.length; i++) {
		if (props[i]) {
			props[i].style.background = '';
		}
	}
	//put highlight on actual props row
	props[id].style.background = '#e7e7e7';
}

/**
 *	Handles delete keypress when focus is on the leading checkbox/radio.
 *	@author	adam 
 */
function gui_cb_keydown(e) {
	if (myimgmap.viewmode === 1) {return;}//exit if preview mode
	var key = (myimgmap.isMSIE) ? event.keyCode : e.keyCode;
	//alert(key);
	if (key == 46) {
		//delete pressed
		myimgmap.removeArea(myimgmap.currentid);
	}
}

/**
 *	Unchecks all checboxes/radios.
 */
function gui_cb_unselect_all() {
	for (var i = 0; i < props.length; i++) {
		if (props[i]) {
			document.getElementById('img_active_'+i).checked = false;
		}
	}
}

/**
 *	Handles arrow keys on img_coords input field.
 *	Changes the coordinate values by +/- 1 and updates the corresponding canvas area.
 *	@author	adam
 *	@date	25-09-2007 17:12:43
 */
function gui_coords_keydown(e) {
	if (myimgmap.viewmode === 1) {return;}//exit if preview mode
	var key = (myimgmap.isMSIE || myimgmap.isOpera) ? event.keyCode : e.keyCode;
	var obj = (myimgmap.isMSIE || myimgmap.isOpera) ? window.event.srcElement : e.originalTarget;
	//obj is the input field
	//this.log(key);
	//this.log(obj);
	if (key == 40 || key == 38) {
		//down or up pressed
		//get the coords
		var coords = obj.value.split(',');
		var s = getSelectionStart(obj);//helper function
		var j = 0;
		for (var i=0, le = coords.length; i<le; i++) {
			j+=coords[i].length;
			if (j > s) {
				//this is the coord we want
				if (key == 40 && coords[i] > 0) {coords[i]--;}
				if (key == 38) {coords[i]++;}
				break;
			}
			//jump one more because of comma
			j++;
		}
		obj.value = coords.join(',');
		if (obj.value != myimgmap.areas[obj.parentNode.aid].lastInput) {
			myimgmap._recalculate(obj.parentNode.aid, obj.value);//contains repaint
		}
		//set cursor back to its original position
		setSelectionRange(obj, s);
		return true;
	}
}

/**
 *	Gets the position of the cursor in the input box.
 *	@author	Diego Perlini
 *	@url	http://javascript.nwbox.com/cursor_position/
 */
function getSelectionStart(obj) {
	if (obj.createTextRange) {
		var r = document.selection.createRange().duplicate();
		r.moveEnd('character', obj.value.length);
		if (r.text === '') {return obj.value.length;}
		return obj.value.lastIndexOf(r.text);
	}
	else {
		return obj.selectionStart;
	}
}

/**
 *	Sets the position of the cursor in the input box.
 *	@link	http://www.codingforums.com/archive/index.php/t-90176.html
 */
function setSelectionRange(obj, start, end) {
	if (typeof end == "undefined") {end = start;}
	if (obj.setSelectionRange) {
		obj.focus(); // to make behaviour consistent with IE
		obj.setSelectionRange(start, end);
	}
	else if (obj.createTextRange) {
		var range = obj.createTextRange();
		range.collapse(true);
		range.moveEnd('character', end);
		range.moveStart('character', start);
		range.select();
	}
}


/**
 *	Called when one of the properties change, and the recalculate function
 *	must be called.
 *	@date	2006.10.24. 22:42:02
 *	@author	Adam Maschek (adam.maschek(at)gmail.com)
 */
function gui_input_change(e) {
	if (myimgmap.viewmode === 1) {return;}//exit if preview mode
	if (myimgmap.is_drawing) {return;}//exit if drawing
	//console.log('blur');
	var obj = (myimgmap.isMSIE) ? window.event.srcElement : e.currentTarget;
	//console.log(obj);
	var id = obj.parentNode.aid;
	//console.log(this.areas[id]);
	if (obj.name == 'img_href')        {myimgmap.areas[id].ahref   = obj.value; myimgmap.config.label = obj.value}
	else if (obj.name == 'img_alt')    {myimgmap.areas[id].aalt    = obj.value;}
	else if (obj.name == 'img_title')  {myimgmap.areas[id].atitle  = obj.value;}
	else if (obj.name == 'img_target') {myimgmap.areas[id].atarget = obj.value;}
	else if (obj.name == 'img_shape') {
		if (myimgmap.areas[id].shape != obj.value && myimgmap.areas[id].shape != 'undefined') {
			//shape changed, adjust coords intelligently inside _normCoords
			var coords = '';
			if (props[id]) {
				coords  =  props[id].getElementsByTagName('input')[2].value;
			}
			else {
				coords = myimgmap.areas[id].lastInput || '' ;
			}
			coords = myimgmap._normCoords(coords, obj.value, 'from'+myimgmap.areas[id].shape);
			if (props[id]) {
				props[id].getElementsByTagName('input')[2].value  = coords;
			}
			myimgmap.areas[id].shape = obj.value;
			myimgmap._recalculate(id, coords);
			myimgmap.areas[id].lastInput = coords;
		}
		else if (myimgmap.areas[id].shape == 'undefined') {
			myimgmap.nextShape = obj.value;
		}
	}
	if (myimgmap.areas[id] && myimgmap.areas[id].shape != 'undefined') {
		myimgmap._recalculate(id, props[id].getElementsByTagName('input')[2].value);
		myimgmap.fireEvent('onHtmlChanged', myimgmap.getMapHTML());//temp ## shouldnt be here
	}
}

/**
 *	Called from imgmap when a new area is added.
 */
function gui_addArea(id) {
	//var id = props.length;
	//id = 1;
	props[id] = document.createElement('DIV');
	document.getElementById('form_container').appendChild(props[id]);

	props[id].id        = 'img_area_' + id;
	props[id].aid       = id;
	props[id].className = 'img_area';
	//hook ROW event handlers
	myimgmap.addEvent(props[id], 'mouseover', gui_row_mouseover);
	myimgmap.addEvent(props[id], 'mouseout',  gui_row_mouseout);
	myimgmap.addEvent(props[id], 'click',     gui_row_click);
	var temp = '<input type="text"  name="img_id" class="img_id" value="' + id + '" readonly="1"/>';
	//temp+= '<input type="checkbox" name="img_active" class="img_active" id="img_active_'+id+'" value="'+id+'">';
	//could be checkbox in the future
	temp+= '<input type="radio" name="img_active" class="img_active" id="img_active_'+id+'" value="'+id+'">';
	temp+= '<select name="img_shape" class="img_shape">';
	temp+= '<option value="rect">rectangle</option>';
	
	var tmp_css = document.getElementById('dd_output')?document.getElementById('dd_output').value:'css';
	
	if (tmp_css != 'css') {
		temp+= '<option value="circle">circle</option>';
		temp+= '<option value="poly">polygon</option>';
		temp+= '<option value="bezier1">bezier</option>';
	}
	temp+= '</select>';
	temp+= 'Coords: <input type="text" name="img_coords" class="img_coords" value="">';
	temp+= 'Href: <input type="text" name="img_href" class="img_href" value="">';
	temp+= 'Alt: <input type="text" name="img_alt" class="img_alt" value="">';
	temp+= 'Target: <select name="img_target" class="img_target">';
	temp+= '<option value=""  >&lt;not set&gt;</option>';
	temp+= '<option value="_self"  >this window</option>';
	temp+= '<option value="_blank" >new window</option>';
	temp+= '<option value="_top"   >top window</option>';
	temp+= '</select>';
	
	
	props[id].innerHTML = temp;
	//hook more event handlers to individual inputs
	
	myimgmap.addEvent(props[id].getElementsByTagName('input')[1],  'keydown', gui_cb_keydown);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[2],  'keydown', gui_coords_keydown);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[2],  'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[3],  'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[4],  'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('select')[0], 'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('select')[1], 'change', gui_input_change);
	if (myimgmap.isSafari) {
		//need these for safari
		myimgmap.addEvent(props[id].getElementsByTagName('select')[0], 'change', gui_row_click);
		myimgmap.addEvent(props[id].getElementsByTagName('select')[1], 'change', gui_row_click);
	}
	//set shape as nextshape if set
	if (myimgmap.nextShape) {props[id].getElementsByTagName('select')[0].value = myimgmap.nextShape;}
	//alert(this.props[id].parentNode.innerHTML);
	gui_row_select(id, true);
}

function gui_text_change(obj){
	myimgmap.config.label = obj.value;
}

function gui_addArea_bak(id) {
	//var id = props.length;
	//id = 1;
	props[id] = document.createElement('DIV');
	document.getElementById('form_container').appendChild(props[id]);

	props[id].id        = 'img_area_' + id;
	props[id].aid       = id;
	props[id].className = 'img_area';
	//hook ROW event handlers
	myimgmap.addEvent(props[id], 'mouseover', gui_row_mouseover);
	myimgmap.addEvent(props[id], 'mouseout',  gui_row_mouseout);
	myimgmap.addEvent(props[id], 'click',     gui_row_click);
	var temp = '<input type="text"  name="img_id" class="img_id" value="' + id + '" readonly="1"/>';
	//temp+= '<input type="checkbox" name="img_active" class="img_active" id="img_active_'+id+'" value="'+id+'">';
	//could be checkbox in the future
	temp+= '<input type="radio" name="img_active" class="img_active" id="img_active_'+id+'" value="'+id+'">';
	temp+= '<select name="img_shape" class="img_shape" style="display:none">';
	temp+= '<option value="rect">rectangle</option>';
	
	var tmp_css = document.getElementById('dd_output')?document.getElementById('dd_output').value:'css';
	
	if (tmp_css != 'css') {
		temp+= '<option value="circle">circle</option>';
		temp+= '<option value="poly">polygon</option>';
		temp+= '<option value="bezier1">bezier</option>';
	}
	temp+= '</select>';
	temp+= 'Coords: <input type="text" name="img_coords" readonly="readonly" class="img_coords" value="">';
	temp+= 'Text: <input type="text" name="img_href" readonly="readonly" class="img_href" value="'+myimgmap.config.areaText[id]+'">';
	
	temp+= '<input type="hidden" name="img_alt" class="img_alt" value="">';
	temp+= '<select name="img_target" class="img_target" style="display:none">';
	temp+= '<option value=""  >&lt;not set&gt;</option>';
	temp+= '<option value="_self"  >this window</option>';
	temp+= '<option value="_blank" >new window</option>';
	temp+= '<option value="_top"   >top window</option>';
	temp+= '</select>';
	temp+= ' Font: <select name="img_font" class="img_target">';
	for(var i=0; i<arr_font.length; i++)
		temp+= arr_font[i];
	//temp+= '<option value="Tahoma">Tahoma</option>';
	//temp+= '<option value="Time News Roman" >Time News Roman</option>';
	//temp+= '<option value="Verdana">Verdana</option>';
	temp+= '</select>';
	temp+= ' Size: <select name="img_color" class="img_target">';
	temp+= '<option value="12pt">12pt</option>';
	temp+= '<option value="14pt">14pt</option>';
	temp+= '<option value="16pt">16pt</option>';
	temp+= '<option value="20pt">20pt</option>';
	temp+= '<option value="24pt">22pt</option>';
	temp+= '<option value="24pt">24pt</option>';
	temp+= '<option value="26pt">26pt</option>';
	temp+= '<option value="28pt">28pt</option>';
	temp+= '<option value="30pt">30pt</option>';
	temp+= '<option value="32pt">32pt</option>';
	temp+= '<option value="34pt">34pt</option>';
	temp+= '<option value="36pt">36pt</option>';
	temp+= '<option value="38pt">38pt</option>';
	temp+= '<option value="40pt">40pt</option>';
	temp+= '<option value="42pt">42pt</option>';
	temp+= '<option value="44pt">44pt</option>';
	temp+= '</select>';
	temp+= ' Color: <select name="img_size" class="img_target">';
	for(var j = 0; j<arr_color.length; j++)
		temp+=arr_color[j];
	temp+= '</select>';
	
	temp+= ' <b>Bold</b> <input type="checkbox" name="img_bold" value="1">';
	temp+= ' <i>Italic</i> <input type="checkbox" name="img_italic" value="1">';
	
	
	props[id].innerHTML = temp;
	//hook more event handlers to individual inputs
	
	myimgmap.addEvent(props[id].getElementsByTagName('input')[1],  'keydown', gui_cb_keydown);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[2],  'keydown', gui_coords_keydown);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[2],  'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[3],  'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[4],  'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('select')[0], 'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('select')[1], 'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('select')[2], 'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('select')[3], 'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('select')[4], 'change', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[5],  'click', gui_input_change);
	myimgmap.addEvent(props[id].getElementsByTagName('input')[6],  'click', gui_input_change);
	if (myimgmap.isSafari) {
		//need these for safari
		myimgmap.addEvent(props[id].getElementsByTagName('select')[0], 'change', gui_row_click);
		myimgmap.addEvent(props[id].getElementsByTagName('select')[1], 'change', gui_row_click);
		myimgmap.addEvent(props[id].getElementsByTagName('select')[2], 'change', gui_row_click);
		myimgmap.addEvent(props[id].getElementsByTagName('select')[3], 'change', gui_row_click);
		myimgmap.addEvent(props[id].getElementsByTagName('select')[4], 'change', gui_row_click);
	}
	//myimgmap.config.label = myimgmap.config.areaText[id];
	//alert(myimgmap.config.areaText[id]);
	//set shape as nextshape if set
	if (myimgmap.nextShape) {props[id].getElementsByTagName('select')[0].value = myimgmap.nextShape;}
	//alert(this.props[id].parentNode.innerHTML);
	gui_row_select(id, true);
}

/**
 *	Called from imgmap when an area was removed.
 */
function gui_removeArea(id) {
	if (props[id]) {
		//shall we leave the last one?
		var pprops = props[id].parentNode;
		pprops.removeChild(props[id]);
		var lastid = pprops.lastChild.aid;
		props[id] = null;
		try {
			gui_row_select(lastid, true);
			myimgmap.currentid = lastid;
		}
		catch (err) {
			//alert('noparent');
		}
	}
}

/**
 *	Called from imgmap when mode changed to a given value (preview or normal)
 */
function gui_modeChanged(mode) {
	var nodes, i;
	if (mode == 1) {
		//preview mode
		if (document.getElementById('html_container')) {
			document.getElementById('html_container').disabled = true;
		}
		//disable form elements (inputs and selects)
		nodes = document.getElementById('form_container').getElementsByTagName("input");
		for (i=0; i<nodes.length; i++) {
			nodes[i].disabled = true;
		}
		nodes = document.getElementById('form_container').getElementsByTagName("select");
		for (i=0; i<nodes.length; i++) {
			nodes[i].disabled = true;
		}
		document.getElementById('i_preview').src = imgroot + 'edit.gif';
		document.getElementById('dd_zoom').disabled = true;
		document.getElementById('dd_output').disabled = true;
	}
	else {
		//normal mode
		if (document.getElementById('html_container')) {
			document.getElementById('html_container').disabled = false;
		}
		//enable form elements (inputs and selects)
		nodes = document.getElementById('form_container').getElementsByTagName("input");
		for (i=0; i<nodes.length; i++) {
			nodes[i].disabled = false;
		}
		nodes = document.getElementById('form_container').getElementsByTagName("select");
		for (i=0; i<nodes.length; i++) {
			nodes[i].disabled = false;
		}
		document.getElementById('i_preview').src = imgroot + 'zoom.gif';
		document.getElementById('dd_zoom').disabled = false;
		document.getElementById('dd_output').disabled = false;
	}
}

/**
 *	Called from imgmap with the new html code when changed.
 */
function gui_htmlChanged(str) {
	var out_element = document.getElementById('dd_output');
	if(out_element){
		var out = document.getElementById('dd_output').value;
		if (document.getElementById('html_container')) {
			if (out == 'css') {
				document.getElementById('html_container').value = output_css();
			}
			else if (out == 'wiki') {
				document.getElementById('html_container').value = output_wiki();
			}
			else {
				document.getElementById('html_container').value = str;
			}
		}
	}else{
		if (document.getElementById('html_container')){
			document.getElementById('html_container').value = output_css();
		}
	}
}

/**
 *	Called from imgmap with new status string.
 */
function gui_statusMessage(str) {
	if (document.getElementById('status_container')) {
		document.getElementById('status_container').innerHTML = str;
	}
	window.defaultStatus = str;//for IE
}

function gui_areaChanged(area) {
	var id = area.aid;
	if (props[id]) {
		if (area.shape)  {props[id].getElementsByTagName('select')[0].value = area.shape;}
		if (area.lastInput) {props[id].getElementsByTagName('input')[2].value  = area.lastInput;}
		if (area.ahref)   {props[id].getElementsByTagName('input')[3].value  = area.ahref;}
		if (area.aalt)    {props[id].getElementsByTagName('input')[4].value  = area.aalt;}
		if (area.atarget) {props[id].getElementsByTagName('select')[1].value = area.atarget;}
	}
}


/**
 *	Called when the grand HTML code loses focus, and the changes must be reflected.
 *	@date	2006.10.24. 22:51:20
 *	@author	Adam Maschek (adam.maschek(at)gmail.com)
 */
function gui_htmlBlur() {
	var elem = document.getElementById('html_container');
	var oldvalue = elem.getAttribute('oldvalue');
	if (oldvalue != elem.value && document.getElementById('dd_output').value == 'imagemap') {
		//dirty
		myimgmap.setMapHTML(elem.value);
	}
}


/**
 *	Called when the optional html container gets focus.
 *	We need to memorize its old value in order to be able to
 *	detect changes in the code that needs to be reflected.
 *	@date	20-02-2007 17:51:16
 *	@author Adam Maschek (adam.maschek(at)gmail.com)
 */
function gui_htmlFocus() {
	var elem = document.getElementById('html_container');
	elem.setAttribute('oldvalue', elem.value);
	elem.select();
}

function gui_htmlShow() {
	toggleFieldset(document.getElementById('fieldset_html'), 1);
	document.getElementById('html_container').focus();
}

/**
 *	Change the labeling mode directly in imgmap config then repaint all areas.
 */
function changelabeling(obj) {
	myimgmap.config.label = obj.value;
	myimgmap._repaintAll();
}

function changelabeling_bak(val) {
	myimgmap.config.label = val;
	myimgmap._repaintAll();
}

/**
 *	Change the bounding box mode straight in imgmap config then relax all areas.
 *	(Relax just repaints the borders and opacity.)
 */
function toggleBoundingBox(obj) {
	obj.checked = !obj.checked;
	obj.innerHTML = '&nbsp; bounding box';
	if (obj.checked) {
		obj.innerHTML = '&raquo; bounding box';
	}
	myimgmap.config.bounding_box = obj.checked;
	myimgmap.relaxAllAreas();
	gui_toggleMore();
}

/**
 *	Toggles fieldset visibility by changing the className.
 *	External css needed with the appropriate classnames. 
 *	@date	2006.10.24. 22:13:34
 *	@author	Adam Maschek (maschek@freemail.hu)
 */
function toggleFieldset(fieldset, on) {
	if (fieldset) {
		if (fieldset.className == 'fieldset_off' || on == 1) {
			fieldset.className = '';
		}
		else {
			fieldset.className = 'fieldset_off';
		}
	}
}

function gui_selectArea(obj) {
	gui_row_select(obj.aid, true, false);
}

function gui_zoom() {
	var scale = document.getElementById('dd_zoom').value;
	var pic = document.getElementById('pic_container').getElementsByTagName('img')[0];
	if (typeof pic == 'undefined') {return false;}
	if (typeof pic.oldwidth == 'undefined' || !pic.oldwidth) {
		pic.oldwidth = pic.width;
	}
	if (typeof pic.oldheight == 'undefined' || !pic.oldheight) {
		pic.oldheight = pic.height;
	}
	pic.width  = pic.oldwidth * scale;
	pic.height = pic.oldheight * scale;
	myimgmap.scaleAllAreas(scale);
}

function gui_loadImage(src) {
	//reset zoom dropdown
	document.getElementById('dd_zoom').value = '1';
	var pic = document.getElementById('pic_container').getElementsByTagName('img')[0];
	if (typeof pic != 'undefined') {
		//delete already existing pic
		pic.parentNode.removeChild(pic);
		delete myimgmap.pic;
	}
	myimgmap.loadImage(src);
}

function gui_outputChanged() {
	var temp, i;
	var clipboard_enabled = (window.clipboardData || typeof air == 'object');
	var output = document.getElementById('dd_output')?document.getElementById('dd_output').value:'css';
	if (output == 'css') {
		//css output selected
		for (i=0; i<myimgmap.areas.length; i++) {
			if (myimgmap.areas[i] && myimgmap.areas[i].shape != 'rect' && myimgmap.areas[i].shape != 'undefined') {
				var others = true;
				break;
			}
		}
		if (others) {
			if (!confirm('CSS maps only support rectangles. Are you sure you want to transform all your areas to rectangles?')) {
				output = outputmode;
				return false;
			}
			else {
				//transform old areas
				for (i = 0; i < props.length; i++) {
					if (props[i] && props[i].getElementsByTagName('select')[0].value != 'rect' && myimgmap.areas[i].shape != 'undefined') {
						var coords = props[i].getElementsByTagName('input')[2].value;
						coords = myimgmap._normCoords(coords, 'rect', 'from'+myimgmap.areas[i].shape);
						myimgmap.areas[i].shape = 'rect';
						myimgmap._recalculate(i, coords);
						myimgmap.areas[i].lastInput = coords;
						//dropdown and new coords will be set when setmaphtml is called,see below
					}
				}
			}
		}
		else if (myimgmap.areas.length > 0 && !confirm('CSS maps only support rectangles. Are you sure you want to use this output mode?')) {
			output = outputmode;
			return false;
		}
		temp = 'This is the generated image map HTML + CSS code. ';
		temp+= 'Click into the textarea below and press Ctrl+C to copy the code to your clipboard. ';
		if (clipboard_enabled) {
			temp+= 'Alternatively you can use the clipboard icon on the right. ';
			temp+= '<img src="lib/imgmap/images/clipboard.gif" onclick="gui_toClipBoard()" style="float: right; margin: 4px; cursor: pointer;"/>';
		}
		temp+= 'Please note, that you have to use a positioned container to make use of the absolute coordinates ';
		temp+= '(<a href="http://css-tricks.com/absolute-positioning-inside-relative-positioning/">read more</a>).'; 
	}
	else if (output == 'wiki') {
		temp = 'This is the generated image map Wiki code to use with MediaWiki ImageMap extension. ';
		temp+= 'Click into the textarea below and press Ctrl+C to copy the code to your clipboard. ';
		if (clipboard_enabled) {
			temp+= 'Alternatively you can use the clipboard icon on the right. ';
			temp+= '<img src="lib/imgmap/images/clipboard.gif" onclick="gui_toClipBoard()" style="float: right; margin: 4px; cursor: pointer;"/>';
		}
		temp+= 'Please note, that you might need to change the Image url ';
		temp+= '(<a href="http://www.mediawiki.org/wiki/Extension:ImageMap">read more</a>).'; 
	}
	else {
		temp = 'This is the generated image map HTML code. ';
		temp+= 'Click into the textarea below and press Ctrl+C to copy the code to your clipboard. ';
		if (clipboard_enabled) {
			temp+= 'Alternatively you can use the clipboard icon on the right. ';
			temp+= '<img src="lib/imgmap/images/clipboard.gif" onclick="gui_toClipBoard()" style="float: right; margin: 4px; cursor: pointer;"/>';
		}
		temp+= 'Please note, that you have to attach this code to your image, via the usemap property ';
		temp+= '(<a href="http://www.htmlhelp.com/reference/html40/special/map.html">read more</a>). '; 
	}
	document.getElementById('output_help').innerHTML = temp;
	//this will reload areas and sets dropdown restrictions
	myimgmap.setMapHTML(myimgmap.getMapHTML());
	outputmode = output;
	return true;
}


/**
 *	Tries to copy imagemap output or text parameter to the clipboard.
 *	If in special environment (eg AIR), use specific functions. 
 *	@date	2006.10.24. 22:14:12
 *	@param	text	Text to copy, otherwise html_container will be used.
 */
function gui_toClipBoard(text) {
	if (typeof text == 'undefined') {text = document.getElementById('html_container').value;}
	try {
		if (window.clipboardData) {
			// IE send-to-clipboard method.
			window.clipboardData.setData('Text', text);
		}
		else if (typeof air == 'object') {
			air.Clipboard.generalClipboard.clear();
			air.Clipboard.generalClipboard.setData("air:text", text, false);
		}
	}
	catch (err) {
		myimgmap.log("Unable to set clipboard data", 1);
	}
}


/** INIT SECTION **************************************************************/
var myimgmap;
//instantiate the imgmap component, setting up some basic config values
myimgmap = new imgmap({
mode : "editor",
custom_callbacks : {
	'onStatusMessage' : function(str) {gui_statusMessage(str);},//to display status messages on gui
	'onHtmlChanged'   : function(str) {gui_htmlChanged(str);},//to display updated html on gui
	'onModeChanged'   : function(mode) {gui_modeChanged(mode);},//to switch normal and preview modes on gui
	'onAddArea'       : function(id)  {gui_addArea_bak(id);},//to add new form element on gui
	'onRemoveArea'    : function(id)  {gui_removeArea(id);},//to remove form elements from gui
	'onAreaChanged'   : function(obj) {gui_areaChanged(obj);},
	'onSelectArea'    : function(obj) {gui_selectArea(obj);}//to select form element when an area is clicked
},
pic_container: document.getElementById('pic_container'),
bounding_box : false,
label: '%h',
maxArea: 4,
areaText: ['VNI Marketing Inc', 'Van Houtte Coffee Services', 'Photo Plus', 'Anvy Digital']
});

//array of form elements
props = [];
imgroot = 'lib/imgmap/images/';
outputmode = 'imgmap';
gui_outputChanged();

myimgmap.addEvent(document.getElementById('html_container'), 'blur',  gui_htmlBlur);
myimgmap.addEvent(document.getElementById('html_container'), 'focus', gui_htmlFocus);

//$('#color1').colorPicker();


/** OUTPUT FUNCTIONS **********************************************************/

/**
 *	Just grab the areas array and do whatever you wish.
 */
function output_css() {
	var html, coords, top, left, width, height;
	html = '<div class="imgmap_css_container" id="'+myimgmap.getMapId()+'">';
	
	//foreach areas
	for (var i=0; i<myimgmap.areas.length; i++) {
		if (myimgmap.areas[i]) {
			if (myimgmap.areas[i].shape && myimgmap.areas[i].shape != 'undefined') {
				coords = myimgmap.areas[i].lastInput;
				top = myimgmap.areas[i].style.top;
				left = myimgmap.areas[i].style.left;
				width = myimgmap.areas[i].style.width;
				height = myimgmap.areas[i].style.height;
				html+= '<a style="position: absolute; top: '+top+'; left: '+left+'; width: '+width+'; height: '+height+';" '+
					' alt="' + myimgmap.areas[i].aalt + '"' +
					' title="' + myimgmap.areas[i].aalt + '"' +
					' href="' +	myimgmap.areas[i].ahref + '"' +
					' target="' + myimgmap.areas[i].atarget + '" ><em>' + myimgmap.areas[i].atitle + '</em></a>';
			}
		}
	}
	html+= myimgmap.waterMark + '</div>';
	//alert(html);
	return html;

}

/**
 *	Grab the areas array and make wiki output.
 *	@link	http://www.mediawiki.org/wiki/Extension:ImageMap
 *	<imagemap>
Image:Foo.jpg|200px|picture of a foo
poly 131 45 213 41 210 110 127 109 [[Display]]
poly 104 126 105 171 269 162 267 124 [[Keyboard]]
rect 15 95 94 176   [[Foo type A]]
# A comment, this line is ignored
circle 57 57 20    [[Foo type B]]
desc bottom-left
</imagemap>
 
 */
function output_wiki() {
	var html, coords;
	html = '<imagemap>';
	if (typeof myimgmap.pic != 'undefined') {
		html+= 'Image:' + myimgmap.pic.src + '|' + myimgmap.pic.title + '\n';
	}
	
	//foreach areas
	for (var i=0; i<myimgmap.areas.length; i++) {
		if (myimgmap.areas[i]) {
			if (myimgmap.areas[i].shape && myimgmap.areas[i].shape != 'undefined') {
				coords = myimgmap.areas[i].lastInput.split(',').join(' ');
				html+= myimgmap.areas[i].shape + ' ' + coords + ' [[' + myimgmap.areas[i].ahref + '|' + myimgmap.areas[i].aalt + ']]\n';
			}
		}
	}
	html+= '#' + myimgmap.waterMark + '\n</imagemap>';
	//alert(html);
	return html;
}

function save_image(obj){
	var data = [];
	var LEN = myimgmap.areas.length;	
	var t, c, f, s, b, it, x, y, j=0;
	var temp, tmp;
	for(var i = 0; i<LEN; i++){
		temp = $.trim(props[i].getElementsByTagName('input')[2].value);
		if(temp!=''){
			tmp = temp.split(',');
			if(tmp.length==4){
				x = tmp[0];
				//y = tmp[1];
				y = tmp[1];
				x = parseInt(x, 10);
				y = parseInt(y, 10);
				
				t = $.trim(props[i].getElementsByTagName('input')[3].value);
				f = props[i].getElementsByTagName('select')[2].value;
				c = props[i].getElementsByTagName('select')[4].value;
				s = props[i].getElementsByTagName('select')[3].value;
				s = s.replace('pt','');
				s = parseInt(s, 10);
				y = y + Math.ceil(s*8/6);
				
				b = props[i].getElementsByTagName('input')[5].checked?1:0;
				it = props[i].getElementsByTagName('input')[6].checked?1:0;
				var node = new Text(t, c, f, s, b,it, x, y);
				data.push(node);
			}
		}
	}
	$this = $('input#'+obj.id+'[type="button"]')
	var send = YAHOO.lang.JSON.stringify(data);
	//alert(send);
	if(data.length>0){
		$.ajax({
			url	: 'createimage.php',
			type	:'POST',
			data	:	{txt_data: send, txt_image:img_work_src, txt_original:img_source_src, txt_rate:rate},
			async: false,
        	cache: false,
        	timeout: 30000,
			beforeSend: function(){
				$this.attr('disabled', true);				
			},
			success: function(data, type){
				var ret = $.parseJSON(data);
				if(ret.error==0){
					$('span#sp_view').css('display','');
					addImage(ret.source);
				}else{
					alert(ret.message);
				}
				$this.attr('disabled', false);				
	//			alert(data);
			}
		});
	}
}
function Text(text, color, font, size, bold, italic, x, y){
	this.text = text;
	this.color = color;
	this.font = font;
	this.size = size;
	this.bold = bold;
	this.italic = italic;
	this.x = x;
	this.y = y;
}
function addImage(src) {
	
	var newImg = document.createElement("img");
	newImg.style.margin = "5px";
	newImg.style.verticalAlign = "middle";
	var div = document.getElementById('pic_result');	
	div.innerHTML = '';
	div.insertBefore(newImg, div.firstChild);
	
	if (newImg.filters) {
		try {
			newImg.filters.item("DXImageTransform.Microsoft.Alpha").opacity = 0;
		} catch (e) {
			// If it is not set initially, the browser will throw an error.  This will set it if it is not set yet.
			newImg.style.filter = 'progid:DXImageTransform.Microsoft.Alpha(opacity=' + 0 + ')';
		}
	} else {
		newImg.style.opacity = 0;
	}

	newImg.onload = function () {
		fadeIn(newImg, 0);
	};
	//alert('Anh: '+src);
	newImg.src = src;
}
function fadeIn(element, opacity) {
	var reduceOpacityBy = 5;
	var rate = 30;	// 15 fps


	if (opacity < 100) {
		opacity += reduceOpacityBy;
		if (opacity > 100) {
			opacity = 100;
		}

		if (element.filters) {
			try {
				element.filters.item("DXImageTransform.Microsoft.Alpha").opacity = opacity;
			} catch (e) {
				// If it is not set initially, the browser will throw an error.  This will set it if it is not set yet.
				element.style.filter = 'progid:DXImageTransform.Microsoft.Alpha(opacity=' + opacity + ')';
			}
		} else {
			element.style.opacity = opacity / 100;
		}
	}

	if (opacity < 100) {
		setTimeout(function () {
			fadeIn(element, opacity);
		}, rate);
	}
}
/** BROWSERPLUS SECTION *******************************************************/

/*
myimgmap.loadScript("http://bp.yahooapis.com/2.1.6/browserplus-min.js");
window.setTimeout(bp_init, 2000);

function bp_init() {
	if (!myimgmap.loadedScripts["http://bp.yahooapis.com/2.1.6/browserplus-min.js"]) return;
	BrowserPlus.init(function(res) {
	  if (res.success) {  
	   BrowserPlus.require({  
	      services: [
		  	{service: 'DragAndDrop'},
		  	{service: "ImageAlter"}
			]},  
	      function(res) {
	        if (res.success) {
	          var dnd = BrowserPlus.DragAndDrop;
	          dnd.AddDropTarget(
	            {id: "pic_container"},
	            function(res) {
	            	document.getElementById("pic_container").innerHTML = '<em>Drag and drop an image here to start editing, or select source above.</em>';
	              dnd.AttachCallbacks({
	                id: "pic_container",
	                drop: bp_dropped
	              },
	              function(){});
	              
	          });
	        } else {
	          //alert("Error Loading Browserplus Services: " + res.error);
	        }
	      });
	  } else {
	    //alert("Failed to initialize BrowserPlus: " + res.error);
	  }
	});
}

function bp_dropped(arg) {  
	bp_renderImage(arg[0]);
}  


function bp_renderImage(img) {
	var params = {};
	params.file = img;
	BrowserPlus.ImageAlter.Alter(params,
		function (result) {
			if (result.success) {
				//remove em element first
				var ems = document.getElementById('pic_container').getElementsByTagName('em');
				if (ems[0]) {
					document.getElementById('pic_container').removeChild(ems[0]);
				}
				myimgmap.loadImage(result.value.url);
			}
	});
}
*/
